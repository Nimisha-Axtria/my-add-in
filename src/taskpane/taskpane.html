<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task Pane Add-in</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

    <!-- Fluent UI -->
    <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"/>

    <!-- Custom styles -->
    <link href="taskpane.css" rel="stylesheet" type="text/css" />
</head>

<body class="ms-font-m ms-welcome ms-Fabric">
    <header class="ms-welcome__header ms-bgColor-neutralLighter">
        <img width="90" height="90" src="../../assets/logo-filled.png" alt="Contoso" title="Contoso" />
        <h1 class="ms-font-su">Excel Add-in Trigger</h1>
    </header>

    <main id="app-body" class="ms-welcome__main" style="display: none;">
        <p class="ms-font-l">Waiting for trigger in cell <b>Z1</b>...</p>
    </main>

    <script>
        Office.onReady(() => {
            document.getElementById("app-body").style.display = "block";

            // Start polling every 2 seconds
            setInterval(checkForTrigger, 2000);
        });

        async function checkForTrigger() {
            await Excel.run(async (context) => {
                const sheet = context.workbook.worksheets.getActiveWorksheet();
                const triggerCell = sheet.getRange("Z1");
                triggerCell.load("values");
                await context.sync();

                const trigger = triggerCell.values[0][0];
                if (trigger === "RunColorChange") {
                    await runColorChange(context);
                    triggerCell.values = [[""]];
                    await context.sync();
                }
            }).catch(error => {
                console.error("Error checking for trigger:", error);
            });
        }

        async function runColorChange(context) {
            const selectedRange = context.workbook.getSelectedRange();
            selectedRange.load(["rowCount", "columnCount"]);
            await context.sync();

            const isSingleCell = selectedRange.rowCount === 1 && selectedRange.columnCount === 1;
            selectedRange.format.fill.color = isSingleCell ? "green" : "yellow";
        }
    </script>
</body>

</html>
